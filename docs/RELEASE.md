# Release Notes

> Track completed work after each iteration.

---

## [Unreleased]

### Added
- Added migration `00060_topup_premium_eligibility_update.sql` to align SQL entitlement + mock checkout behavior with the updated top-up policy (premium-active organizations can purchase extra credits without waiting for package exhaustion).
- Added sidebar billing-progress helper + unit tests to compute decreasing remaining-credit progress for trial/premium states (`src/lib/billing/sidebar-progress.ts`, `src/lib/billing/sidebar-progress.test.ts`).
- Added billing checkout refresh signal helper + unit tests so query-based checkout state changes can trigger deterministic billing snapshot refresh in client navigation surfaces (`src/lib/billing/refresh-signal.ts`, `src/lib/billing/refresh-signal.test.ts`).
- Added DB-persisted conversation AI usage totals (`ai_usage_*`) on `conversations` with migration `00059_conversation_ai_usage_totals.sql` (insert trigger + historical backfill) so Inbox details read cumulative credits without per-open aggregation queries (`supabase/migrations/00059_conversation_ai_usage_totals.sql`, `src/components/inbox/InboxContainer.tsx`, `src/types/database.ts`).
- Added tenant `Plans & Credits` action surface with mock checkout simulation controls for recurring premium and top-up purchases (success/failure outcomes), policy-aware lock messaging, and localized checkout status feedback (`src/app/[locale]/(dashboard)/settings/plans/page.tsx`, `src/lib/billing/mock-checkout.ts`).
- Added billing package-offer resolver + unit tests to derive tenant-visible monthly premium price/credit defaults from versioned package rows with safe fallbacks (`src/lib/billing/package-offer.ts`, `src/lib/billing/package-offer.test.ts`).
- Added rollout migration `supabase/migrations/00058_trial_backfill_mock_checkout_and_admin_overrides.sql` to backfill existing non-system-admin orgs into trial, expose mock checkout SQL functions, and extend admin override SQL functions.
- Added system-admin organization detail actions for trial credit adjustment, package credit adjustment, and explicit membership/lock override controls with required reason capture (`src/app/[locale]/(dashboard)/admin/organizations/[id]/page.tsx`, `src/lib/admin/billing-manual.ts`).
- Added organization-level billing action history table to admin organization detail, showing manual action date/type/actor/reason from `billing_admin_audit_log` (`src/lib/admin/read-models.ts`, `src/app/[locale]/(dashboard)/admin/organizations/[id]/page.tsx`, `messages/en.json`, `messages/tr.json`).
- Added a comprehensive paywall implementation blueprint (`docs/plans/2026-02-12-paywall-trial-credit-implementation-plan.md`) covering billing schema, entitlement enforcement, admin defaults, recurring premium + top-up checkout/webhooks, rollout strategy, and verification steps.
- Added subscription-first billing foundation artifacts: migration `supabase/migrations/00057_billing_subscription_foundation.sql`, billing policy/snapshot domain helpers (`src/lib/billing/policy.ts`, `src/lib/billing/snapshot.ts`, `src/lib/billing/server.ts`), and unit coverage (`src/lib/billing/policy.test.ts`, `src/lib/billing/snapshot.test.ts`).
- Added tenant billing visibility surfaces: control panel cards + credit ledger history in Settings Billing, plus compact trial/credit status visibility in desktop sidebar and mobile More menu (`src/app/[locale]/(dashboard)/settings/billing/page.tsx`, `src/design/MainSidebar.tsx`, `src/design/MobileBottomNav.tsx`).
- Added platform-admin billing visibility in read models and pages (membership state, lock reason, trial/package/top-up used/remaining) across dashboard/org detail/user detail tables (`src/lib/admin/read-models.ts`, `src/app/[locale]/(dashboard)/admin/page.tsx`, `src/app/[locale]/(dashboard)/admin/organizations/page.tsx`, `src/app/[locale]/(dashboard)/admin/organizations/[id]/page.tsx`, `src/app/[locale]/(dashboard)/admin/users/[id]/page.tsx`).
- Added shared runtime entitlement gate helper (`src/lib/billing/entitlements.ts`) and tests (`src/lib/billing/entitlements.test.ts`) with billing-lock regression coverage in inbound pipeline tests.
- Added paywall lock enforcement on token-consuming flows: shared inbound AI pipeline, Telegram webhook AI processing, simulator AI generation, and inbox summary/score-reason/manual lead-refresh actions.
- Added system-admin billing default controls for platform-level trial/package policy updates (trial days, trial credits, package price, package credits) with required reason capture and package-version write-through (`src/lib/admin/billing-settings.ts`, `src/lib/admin/billing-settings.test.ts`, `src/app/[locale]/(dashboard)/admin/page.tsx`).
- Added per-organization system-admin manual billing operations UI (extend trial, adjust top-up credits, assign/cancel premium) with localized feedback and reason-required forms (`src/lib/admin/billing-manual.ts`, `src/lib/admin/billing-manual.test.ts`, `src/app/[locale]/(dashboard)/admin/organizations/[id]/page.tsx`).
- Added tenant `Plans & Credits` route scaffold at `/settings/plans` with live trial/premium status snapshot (trial remaining days/credits and premium package/top-up summary) (`src/app/[locale]/(dashboard)/settings/plans/page.tsx`).
- Added Sign Up legal-consent link helpers and regression tests to lock Terms/Privacy URLs, new-tab behavior, and underlined link styling (`src/components/auth/registerConsentLinks.ts`, `src/components/auth/registerConsentLinks.test.ts`, `src/components/auth/registerConsentStyles.ts`, `src/components/auth/registerConsentStyles.test.ts`).
- Added executable Phase 9 QA closure plan (`docs/plans/2026-02-10-phase-9-testing-qa-implementation-plan.md`) covering unit, WhatsApp integration, admin E2E, and load-test workstreams.
- Added core channel QA unit suites for Phase 9 (`src/lib/channels/actions.test.ts`, `src/lib/channels/inbound-ai-pipeline.test.ts`) to cover WhatsApp channel actions and inbound AI pipeline guardrails.
- Added WhatsApp webhook route integration tests (`src/app/api/webhooks/whatsapp/route.test.ts`) for verify challenge, signature rejection, and pipeline handoff.
- Added admin panel Playwright smoke coverage with env-gated system-admin login helper (`tests/e2e/admin-panel.spec.ts`, `tests/e2e/helpers/auth.ts`).
- Added message-handling load baseline script using `autocannon` (`scripts/load/whatsapp-webhook.autocannon.mjs`) plus thresholds doc (`docs/plans/phase-9-load-test-thresholds.md`).
- Added Phase 9 QA npm command surface and tooling (`test:unit:core`, `test:integration:whatsapp`, `test:e2e:admin`, `test:load:messages`, `playwright.config.ts`, and dev deps `@playwright/test` + `autocannon`).
- Added Channels card configuration helper + test coverage (`src/components/channels/channelCards.ts`, `src/components/channels/channelCards.test.ts`) to support launch-gated placeholder cards.
- Added new lead status `undetermined` (TR: `Belirsiz`) across extraction/UI flows, including migration `supabase/migrations/00056_leads_status_undetermined.sql` to extend `leads.status` constraint.
- Added localized status labels for `undetermined` in both Inbox and Leads dictionaries (`messages/en.json`, `messages/tr.json`) and wired admin/leads/inbox status maps to render them.
- Added role-aware lead-extraction context builder (`buildLeadExtractionConversationContext`) with test coverage so extraction can read recent `customer`/`owner`/`assistant` turns and resolve short confirmations (for example, `Evet`) against the preceding question.
- Added lead-service inference guard coverage in `src/lib/leads/extraction.test.ts` for greeting-only messages, explicit service mentions, and catalog-alias matches.
- Added conversation-list lead-status sync helper + tests (`src/components/inbox/conversationLeadStatus.ts`, `src/components/inbox/conversationLeadStatus.test.ts`) so left-pane lead chips stay aligned with latest lead state.
- Added footer section-link mapping helpers and tests in `qualy-lp` (`lib/footer-links.ts`, `lib/footer-links.test.ts`) for stable Product→homepage section routing.
- Added popup-based Meta OAuth channel connect flow for WhatsApp/Instagram in Channels settings, including postMessage handoff so popup completion returns status to the main page automatically.
- Added shared Meta OAuth origin resolver utility (`src/lib/channels/meta-origin.ts`) with tests to prioritize canonical app URL and gracefully fall back to forwarded/request origin.
- Added Meta OAuth WhatsApp discovery fallback logic that traverses `me/businesses` and business WABA edges when direct `/me/whatsapp_business_accounts` is unsupported for the logged-in user token.
- Added landing legal center infrastructure in `qualy-lp`: markdown source docs (`legal/terms.md`, `legal/privacy.md`), runtime legal routes (`/legal`, `/terms`, `/privacy`), shared legal shell/pages, and legal markdown parser utilities with Vitest coverage (`lib/legal-utils.ts`, `lib/legal.test.ts`).
- Added build-time legal manifest generation (`scripts/generate-legal-assets.mjs`) and `prebuild` hook to emit `public/legal_versions.json` from markdown frontmatter versions.
- Added route-aware browser tab title sync component (`src/components/common/TabTitleSync.tsx`) with dashboard/auth layout wiring so tabs render `Page | Qualy`.
- Added tab-title utility + tests (`src/lib/tab-title.ts`, `src/lib/tab-title.test.ts`) for locale-safe route resolution and title formatting.
- Added branding regression coverage in `src/app/[locale]/layout.metadata.test.ts` to lock `Qualy` tab metadata/icon settings and prevent legacy name reintroduction in EN/TR common labels.
- Added auth preview sending-state microcopy (`Sending...`/`Gönderiliyor...`) for short dispatch feedback before sent confirmation.
- Added auth preview sent-state microcopy (`Sent`/`Gönderildi`) to emphasize message dispatch before assistant response.
- Added animated messenger-style auth right-panel preview (`AuthMessengerPreview`) with typed/deleted customer and Qualy message loops.
- Added conversion-focused auth preview copy keys in EN/TR for rotating user and assistant messages, typing label, and idle composer prompt.
- Added a redesigned public auth shell with top branding (`/logo-black.svg`), inline EN/TR language switcher, and a desktop right-side visual canvas panel.
- Added password visibility toggles (show/hide) to both Sign In and Sign Up forms.
- Added shared password-recovery style helpers and tests (`src/components/auth/passwordRecoveryStyles.ts`, `src/components/auth/passwordRecoveryStyles.test.ts`) to keep Forgot/Reset visuals aligned with auth defaults.
- Added a required consent checkbox to Sign Up and localized copy keys for consent/password-visibility/language/auth-canvas labels in both EN/TR message catalogs.
- Added system-admin org-context regression tests in `src/lib/organizations/active-context.test.ts` to lock slim-mode navigation behavior vs full-list mode.
- Added `GET /api/organizations/active` for on-demand system-admin organization option loading in the sidebar picker.
- Added shared admin loading surface (`src/components/common/AdminRouteLoading.tsx`) using subtle animated `/icon-black.svg` branding.
- Added explicit admin loading boundaries for `/admin/organizations`, `/admin/organizations/[id]`, `/admin/users`, and `/admin/users/[id]`.
- Added system-admin sidebar organization picker modal flow with search, active indicator, and explicit `Select/Change` action from compact current-org summary.
- Added system-admin organization discovery fallback to membership-linked organizations when full organization list query is unavailable.
- Added inbox conversation loading fallback test coverage in `src/lib/inbox/actions.test.ts` for nested-query failure scenarios.
- Added read-only system-admin lead list route at `/admin/leads`, scoped to the active organization switcher context and reusing existing lead search/sort/pagination UI.
- Added admin dashboard lead visibility for active org context: selected-organization summary, recent leads preview table, and quick navigation to `/admin/leads`.
- Added Admin sidebar navigation entry for `/admin/leads` plus TR/EN localization keys (`mainSidebar.adminLeads` and `admin.leads.*`).
- Added desktop settings route warmup by prefetching settings destinations in `MainSidebar` and `SettingsResponsiveShell`.
- Added WhatsApp Meta Cloud MVP implementation with Meta OAuth onboarding (`/api/channels/meta/start` + `/api/channels/meta/callback`), channel debug support, `POST/GET /api/webhooks/whatsapp`, and text-only reactive outbound sending from inbox.
- Added WhatsApp integration helpers with unit tests (`src/lib/whatsapp/client.ts`, `src/lib/whatsapp/webhook.ts`, `src/lib/whatsapp/client.test.ts`, `src/lib/whatsapp/webhook.test.ts`).
- Added Instagram channel implementation as a separate integration type (`channels.type='instagram'`) with dedicated webhook route `POST/GET /api/webhooks/instagram`.
- Added Instagram integration helpers with unit tests (`src/lib/instagram/client.ts`, `src/lib/instagram/webhook.ts`, `src/lib/instagram/client.test.ts`, `src/lib/instagram/webhook.test.ts`).
- Added shared inbound AI pipeline (`src/lib/channels/inbound-ai-pipeline.ts`) and wired Meta channel webhook processing to reuse common Skill → KB/RAG → fallback + escalation behavior.
- Added Instagram connect/debug support in Channels settings, including connect modal fields and brand icon visibility across Channels, Inbox, and Leads surfaces.
- Added database migration `00055_add_instagram_channel_support.sql` to extend channel/platform constraints for `instagram`.
- Added simulator style helper tests (`src/components/chat/simulatorStyles.test.ts`) to lock neutral chatbot theming and prevent WhatsApp-style regressions.
- Added WhatsApp Meta Cloud MVP design blueprint at `docs/plans/2026-02-08-whatsapp-meta-cloud-mvp-design.md` with validated scope: OAuth channel setup, inbound text-only processing, and reactive replies only.
- Added shared Meta OAuth helper module (`src/lib/channels/meta-oauth.ts`) with signed-state validation and channel-candidate extraction tests.
- Added one-click OAuth channel connect UX for WhatsApp/Instagram cards (direct redirect from `Bağla`).
- Added prompt-budget guardrail for Knowledge→Offering Profile/Required Intake pipelines by truncating oversized document content before LLM suggestion prompts.
- Added explicit `max_tokens` caps for router, fallback, RAG, summary, lead reasoning, and extraction calls to keep response size/cost predictable.
- Added structured-output hardening for JSON-producing LLM calls by enabling `response_format: { type: "json_object" }` in lead extraction, required-intake follow-up, and offering-profile suggestion pipelines.
- Added explicit `Coming Soon` badge to Knowledge Base New Content `PDF Upload` source while keeping placeholder handlers unchanged for non-MVP providers.
- Added a troubleshooting-driven quality pass covering tests, hooks, lint debt, and TypeScript strictness across AI/Inbox/Knowledge/Leads modules.
- Added explicit typed models for inbox conversation list rows (`ConversationListItem`) and Telegram debug responses to prevent unsafe UI assumptions.
- Added an ESM-based i18n validation runner (`scripts/i18n/check-i18n.mjs`) and updated npm script wiring.
- Inbox composer banner now reflects bot mode state: Active keeps the assistant-active message, while Shadow/Off show an explicit “AI assistant is not active” notice.
- Mobile dashboard shell now includes an app-style bottom navbar on small screens with 5 items: Inbox, Kişiler, Yetenekler, Bilgi Bankası, and Diğer.
- Mobile “Diğer” menu now exposes quick actions for Simülatör, Ayarlar, and Signout.
- Inbox now supports mobile single-pane flow: conversation list opens a dedicated chat detail view with back navigation.
- Mobile chat header now includes a Details toggle that expands/collapses compact contact and lead snapshot cards.
- Mobile details cards now include lead summary, service type, and collected required-intake info.
- Mobile operator takeover view now shows a clearly visible Leave Conversation action in chat.
- Mobile inbox transitions now animate as horizontal slide-in/slide-out between list and conversation detail views.
- Mobile details panel now adds a dark background overlay and supports tap-outside close behavior.
- Mobile details panel open/close now uses smooth transition (fade + slight slide).
- Skills page now supports mobile single-pane flow: the skill list is a standalone page, and tapping a skill opens a dedicated detail/edit pane with back navigation.
- Settings page now supports mobile single-pane flow: tapping Ayarlar opens a dedicated `/settings` list first, then selected settings open as animated detail pages with mobile back navigation.
- Knowledge Base now supports mobile single-pane flow: the left knowledge sidebar is hidden on mobile and files render as touch-friendly cards.
- Leads page now renders a compact mobile-first card list (reduced spacing/margins) while preserving the existing desktop sortable table layout.
- Lead extraction now enforces locale-aware output language (TR/EN) for user-facing extracted fields, including lead summary and important-info values.
- Inbox on-demand conversation summary now accepts active UI locale (TR/EN) and generates locale-matched output.
- Admin organization list now supports search + pagination for large tenant sets.
- Admin user list now supports search + pagination for large profile sets.
- Added `/admin/organizations/[id]` read-only details page with organization snapshot cards and profile/member layer.
- Platform admin organization switcher (searchable, cookie-persisted active org context) in main sidebar for system admins.
- Main sidebar header now uses `/public/logo-black.svg` in expanded mode and `/public/icon-black.svg` in collapsed mode.
- Cross-tenant read-only impersonation mode across Inbox, Leads, Skills, Knowledge Base, Simulator, and Settings.
- Read-only admin analytics views:
  - `/admin/organizations` now shows org-level usage, token usage, skills, knowledge counts, and premium/plan/trial placeholders.
  - `/admin/users` now shows all profiles with organization memberships.
  - `/admin/users/[id]` added for read-only user detail snapshots by organization.
- New admin read-model layer (`src/lib/admin/access.ts`, `src/lib/admin/read-models.ts`) for centralized system-admin access checks and summary aggregation.
- Added platform admin planning docs for searchable organization switcher + tenant impersonation flow and admin organization details controls (`docs/plans/2026-02-07-platform-admin-org-switcher-implementation-plan.md`).
- Updated PRD and Roadmap to include planned platform admin scope: cross-org switcher, organization-level analytics columns, and premium/trial/quota management modules.
- Confirmed platform admin decisions: switched-org impersonation is read-only in tenant modules, quotas are visibility-only for now, and admin details will include both organization + profile layers (multi-profile-ready).
- Documented minimal day-1 default guardrail system skills (human support request, complaint, urgent, privacy) with dedicated localized handover messages and explicit decision to skip low-confidence/no-safe-answer auto-handover for MVP.
- Added implementation plan and product-spec updates for unified single-list Skills management (no Core/Custom split).
- Skills now auto-seed localized minimal guardrail defaults (human support, complaint, urgent, privacy) when an organization has no skills yet.
- Added automatic skill-embedding backfill on Skills load for orgs with SQL-seeded skills that are missing vectors.
- Skill embeddings now include both skill title and trigger phrases; embeddings regenerate when title/trigger fields change.
- Usage & Billing now includes message usage cards for monthly UTC and all-time totals (AI-generated, operator-sent, customer inbound).
- Usage & Billing now includes storage usage cards with total estimated size and Skills vs Knowledge Base breakdown.
- Added `src/lib/billing/usage.ts` plus unit tests for message and storage usage calculations.
- Human escalation policy implementation (Telegram): centralized precedence (`skill override > hot lead score`), AI Settings two-step controls (automatic escalation + skill handover), and runtime operator switch + bot message execution.
- Skills now support `Requires Human Handover` with read-only bot message preview and deep-link to AI Settings (`Human Escalation` section + handover message focus).
- AI Settings form now shows a dedicated divider above the Bot Name section for clearer section separation.
- Human escalation copy polish: TR label now uses `Kişi çıkarım skoru`, step title uses `Yetenek tabanlı devir`, and the locale helper text under bot message is removed.
- AI Settings sensitivity slider now uses the same blue right-side (`>=`) threshold highlight style as the human escalation score slider for consistent semantics.
- Skill and KB similarity matching now use inclusive threshold checks (`>=`) to match the sensitivity slider semantics.
- Human escalation labels now use `Bot mesajı` / `Bot message` in AI Settings and Skills read-only preview (replacing `Asistan Sözü` / `Assistant's Promise`).

### Changed
- Changed mobile More-menu usage card to show the same low-credit warning badge used by desktop/sidebar/plans when remaining credits fall below 10% (`src/design/MobileBottomNav.tsx`).
- Changed desktop collapsed sidebar billing visibility by adding a compact circular credit-progress chip (segment-aware package + extra-credit ring) with hover tooltip details and Plans deep-link, so remaining credits stay visible even when the sidebar is collapsed (`src/design/MainSidebar.tsx`).
- Changed Plans > Current plan extra-credit card to mirror monthly-package credit semantics: replaced status copy with remaining/total values and added a dedicated depletion progress bar using purple styling (`src/app/[locale]/(dashboard)/settings/plans/page.tsx`).
- Changed sidebar and Plans credit-status UX to show a warning badge (`Kullanım limitine yaklaşılıyor / Approaching usage limit`) when remaining credits fall below 10%, backed by a shared billing progress helper so threshold logic stays consistent across surfaces (`src/lib/billing/sidebar-progress.ts`, `src/lib/billing/sidebar-progress.test.ts`, `src/design/MainSidebar.tsx`, `src/app/[locale]/(dashboard)/settings/plans/page.tsx`, `messages/tr.json`, `messages/en.json`).
- Changed desktop sidebar navigation structure so `DİĞER / Other` now appears directly under `Yapay zeka araçları / AI Tools` in the same section flow; removed separate footer-section rendering and kept notification-dot behavior for Settings in the unified list (`src/design/MainSidebar.tsx`).
- Changed Plans > Current plan credit progress bars to the same decreasing remaining-credit logic used in sidebar usage cards; trial and monthly package bars now represent remaining credits (not used credits), and ratio text now reflects remaining/limit (`src/app/[locale]/(dashboard)/settings/plans/page.tsx`).
- Changed Billing > Usage layout by removing the separate `Hesap durumu / Account status` section so the page stays focused on `Kredi kullanımı / Credit usage` and `Kredi geçmişi / Credit history` only (`src/app/[locale]/(dashboard)/settings/billing/page.tsx`).
- Changed top-up eligibility policy in app logic so active premium organizations can buy extra credits even when monthly package credits remain (`src/lib/billing/policy.ts`, `src/lib/billing/policy.test.ts`, `src/lib/billing/snapshot.test.ts`, `src/app/[locale]/(dashboard)/settings/plans/page.tsx`).
- Changed desktop sidebar usage card to compact mode: removed always-visible verbose sublines, switched progress bar to remaining-credit (decreasing) behavior, and added chevron-expand breakdown for package vs extra-credit balances (`src/design/MainSidebar.tsx`, `messages/en.json`, `messages/tr.json`).
- Changed mobile More usage card progress to the same decreasing remaining-credit model for consistency (`src/design/MobileBottomNav.tsx`, `src/lib/billing/sidebar-progress.ts`).
- Changed desktop sidebar and mobile More billing cards to re-fetch `organization_billing_accounts` when checkout query-state changes, so subscription upgrades reflect immediately without manual reload (`src/design/MainSidebar.tsx`, `src/design/MobileBottomNav.tsx`).
- Changed user-facing billing terminology to `Ek kredi` / `Extra credits` instead of `Top-up` across plans/usage/sidebar/admin dictionaries and billing lock copy (`messages/tr.json`, `messages/en.json`, `src/lib/chat/actions.ts`).
- Changed admin dashboard stats so `Toplam Mesaj`, `Toplam Token`, and `Toplam Kullanılan Kredi` cards now support a shared `All Time / Month` period selector in the dashboard UI (`src/app/[locale]/(dashboard)/admin/page.tsx`, `src/lib/admin/dashboard-metric-period.ts`, `messages/tr.json`, `messages/en.json`).
- Changed admin sidebar `Yönetim/Admin` menu icons to a consistent Heroicons v2 set from `react-icons/hi2` (dashboard, organizations, billing, users) to avoid mixed icon families (`src/design/MainSidebar.tsx`).
- Changed mobile `Diğer` menu to keep a single Settings entry and removed duplicated `Faturalandırma` / `Kullanım` shortcuts (`src/design/MobileBottomNav.tsx`).
- Changed admin dashboard metric semantics so no explicit org selection uses platform-wide credit totals, explicit org selection uses active-org credit totals, and the message stat label is now explicit (`Toplam Mesaj` / `Total Messages`) (`src/app/[locale]/(dashboard)/admin/page.tsx`, `src/lib/admin/read-models.ts`, `src/lib/admin/dashboard-context.ts`, `messages/tr.json`, `messages/en.json`).
- Changed admin dashboard layout by removing top intro/read-only/active-organization summary blocks and adding a monthly plan metrics section (plan payment amount/count, top-up payment amount, top-up credits purchased/used) scoped by platform vs active organization selection (`src/app/[locale]/(dashboard)/admin/page.tsx`, `src/lib/admin/read-models.ts`, `src/lib/admin/billing-plan-metrics.ts`, `messages/tr.json`, `messages/en.json`).
- Changed Inbox credit-usage rendering to read persisted `conversations.ai_usage_total_credits` directly, removing per-refresh/server-side aggregation calls during thread open and message refresh (`src/components/inbox/InboxContainer.tsx`, `src/lib/inbox/actions.ts`).
- Changed settings IA by moving interface language selection from `Settings > General` into `Settings > Organization`, removing the `General` item from settings navigation, and redirecting legacy `/settings/general` requests to `/settings/organization` (`src/app/[locale]/(dashboard)/settings/organization/OrganizationSettingsClient.tsx`, `src/components/settings/SettingsResponsiveShell.tsx`, `src/components/settings/mobilePaneState.ts`, `src/app/[locale]/(dashboard)/settings/general/page.tsx`, `src/design/MainSidebar.tsx`, `messages/en.json`, `messages/tr.json`).
- Changed desktop sidebar and mobile More usage cards to state-aware, decision-first copy: trial shows trial credits only, premium shows package remaining + top-up breakdown, and locked/non-active states show short action prompts (`src/design/MainSidebar.tsx`, `src/design/MobileBottomNav.tsx`, `messages/en.json`, `messages/tr.json`).
- Changed desktop sidebar layout to anchor the `Usage` card in the bottom area (below the `Other/Settings` block and above profile) for a clearer hierarchy (`src/design/MainSidebar.tsx`).
- Changed system-admin sidebar behavior so tenant navigation groups (`Workspace`, `AI Tools`, `Other/Settings`) and the usage card stay hidden until an explicit organization is selected; no-selection state now shows only the `Admin` section (`src/app/[locale]/(dashboard)/layout.tsx`, `src/design/MainSidebar.tsx`).
- Changed platform billing defaults management IA by moving controls from `/admin` dashboard to dedicated `/admin/billing`, with new admin sidebar entry and dashboard quick-action link (`src/app/[locale]/(dashboard)/admin/page.tsx`, `src/app/[locale]/(dashboard)/admin/billing/page.tsx`, `src/design/MainSidebar.tsx`, `messages/en.json`, `messages/tr.json`).
- Changed all `/admin` pages to use full-width content regions and enabled horizontal overflow on shared `DataTable` surfaces for wide table sets (`src/app/[locale]/(dashboard)/admin/page.tsx`, `src/app/[locale]/(dashboard)/admin/organizations/page.tsx`, `src/app/[locale]/(dashboard)/admin/organizations/[id]/page.tsx`, `src/app/[locale]/(dashboard)/admin/users/page.tsx`, `src/app/[locale]/(dashboard)/admin/users/[id]/page.tsx`, `src/app/[locale]/(dashboard)/admin/leads/page.tsx`, `src/design/primitives.tsx`).
- Changed `Settings > Usage & Billing` to be explicitly read-only for top-up/subscription actions by adding a `Go to Plans & Credits` notice and clarifying top-up balance copy as tracking-only (`src/app/[locale]/(dashboard)/settings/billing/page.tsx`, `messages/en.json`, `messages/tr.json`).
- Changed `Settings > Usage & Billing` information architecture to remove duplicate plan-credit UI and keep only billing account context (membership/lock/pool/usage state), immutable credit ledger, and usage analytics (`src/app/[locale]/(dashboard)/settings/billing/page.tsx`, `messages/en.json`, `messages/tr.json`).
- Changed `Settings > Plans` and `Settings > Billing` UX copy to a shorter decision-first language set, removed mock payment outcome selectors from user-facing purchase cards, and simplified Billing to core sections (account status, credit history, AI usage) while keeping backend billing logic unchanged (`src/app/[locale]/(dashboard)/settings/plans/page.tsx`, `src/app/[locale]/(dashboard)/settings/billing/page.tsx`, `messages/en.json`, `messages/tr.json`).
- Changed Turkish billing/paywall terminology to use `Ücretsiz deneme` across sidebar, plans, usage, admin, and lock-state copy instead of raw `Trial` phrasing (`messages/tr.json`, `src/lib/chat/actions.ts`).
- Changed desktop sidebar + mobile More billing quick cards to deep-link into `Settings > Plans` and show richer trial/premium sublines (trial days + credits, top-up active state) aligned with conversion-first paywall UX (`src/design/MainSidebar.tsx`, `src/design/MobileBottomNav.tsx`, `messages/en.json`, `messages/tr.json`).
- Changed admin manual-billing action labeling/copy to include new trial/package/membership override operations and localized action-status labels (`messages/en.json`, `messages/tr.json`).
- Changed monetization requirements docs to keep subscription-first conversion while updating top-up policy: top-up remains blocked during trial but is available for any active premium subscription (package-credit exhaustion no longer required), with package price (`X TL`) + included credits (`Y`) admin-configurable and monthly package credits non-rollover (`docs/PRD.md`, `docs/ROADMAP.md`).
- Changed desktop sidebar usage quick-card interaction so premium breakdown toggle moved to an inline chevron at the right side of the progress row (removed separate “Show breakdown” line), and details now expand/collapse with smooth animation to show package credits, extra credits, and package renewal timing (`src/design/MainSidebar.tsx`, `messages/en.json`, `messages/tr.json`).
- Changed desktop sidebar and mobile More usage progress bars to render separate package and extra-credit segments (two colors) while preserving total remaining-credit progress logic (`src/lib/billing/sidebar-progress.ts`, `src/lib/billing/sidebar-progress.test.ts`, `src/design/MainSidebar.tsx`, `src/design/MobileBottomNav.tsx`).
- Changed Plans > extra-credit purchase flow from direct submit to a Codex-style modal step (`Kredi ekle/Add credits` -> `Sonraki/Next`) and added explicit one-time-purchase copy for extra credits in TR/EN (`src/app/[locale]/(dashboard)/settings/plans/TopupCheckoutCard.tsx`, `src/app/[locale]/(dashboard)/settings/plans/page.tsx`, `messages/tr.json`, `messages/en.json`).
- Changed Plans > Actions section microcopy and information hierarchy: simplified the section description text, removed the redundant premium-active explanatory sentence from the active card, and moved `Kullanımı gör / View usage` under the section description with persistent underline styling for clearer click affordance (`src/app/[locale]/(dashboard)/settings/plans/page.tsx`, `messages/tr.json`, `messages/en.json`).
- Changed usage progress visual legend alignment: extra-credit progress segment switched from green to purple (matching inbox AI tone), and expanded sidebar package/top-up rows now include leading colored dots (package dark, extra-credit purple) so segment meaning is immediately clear (`src/design/MainSidebar.tsx`, `src/design/MobileBottomNav.tsx`).
- Changed Plans > extra-credit action card to hide fixed amount/credit bundle text and keep pricing details in the popup step only, preserving flexibility for future multi-tier top-up packages (`src/app/[locale]/(dashboard)/settings/plans/TopupCheckoutCard.tsx`).
- Changed Plans extra-credit modal presentation to match the existing light dialog language (removed dark panel styling), updated modal title to `Daha fazla kredi al / Get more credits`, and moved modal rendering to `document.body` via portal so the black overlay dims the entire app shell (not only the plans content column) (`src/app/[locale]/(dashboard)/settings/plans/TopupCheckoutCard.tsx`, `messages/tr.json`, `messages/en.json`).
- Changed Billing > Usage layout and ledger UX: moved `Kredi geçmişi / Credit history` section below `Kredi kullanımı / Credit usage`, show only the latest 3 ledger rows by default with `Daha fazla göster / Show more` toggle for the rest, and localized common system-generated `Neden / Reason` values (mock checkout success + AI usage debit) to avoid mixed EN/TR in Turkish UI (`src/app/[locale]/(dashboard)/settings/billing/page.tsx`, `src/app/[locale]/(dashboard)/settings/billing/BillingLedgerTable.tsx`, `messages/tr.json`, `messages/en.json`).
- Changed admin billing visibility from placeholders to live read-only snapshots and updated EN/TR dictionaries for membership/lock/pool/ledger copy (`messages/en.json`, `messages/tr.json`).
- Changed platform-admin billing surfaces from visibility-only placeholders to actionable controls with reason capture and localized success/error messaging (`messages/en.json`, `messages/tr.json`, `src/app/[locale]/(dashboard)/admin/page.tsx`, `src/app/[locale]/(dashboard)/admin/organizations/[id]/page.tsx`).
- Changed settings navigation so `Plans` is now an actual destination (`/settings/plans`) and `Usage & Billing` remains mapped to `/settings/billing`; mobile settings pane state now recognizes `plans` as an active detail route (`src/components/settings/SettingsResponsiveShell.tsx`, `src/components/settings/mobilePaneState.ts`, `src/components/settings/mobilePaneState.test.ts`).
- Changed inbox lead-reasoning and manual lead-refresh UX copy to show explicit billing-lock messaging when entitlement denies AI usage.
- Changed channel platform icon rendering in Settings > Channels, Inbox, and Leads list to use shared public SVG assets (`/Telegram.svg`, `/whatsapp.svg`, `/instagram.svg`, `/messenger.svg`) while keeping Telegram/WhatsApp active and Instagram/Messenger launch-gated as `Coming Soon` (`src/lib/channels/platform-icons.ts`, `src/components/channels/ChannelCard.tsx`, `src/components/inbox/InboxContainer.tsx`, `src/components/leads/LeadsTable.tsx`).
- Changed Sign Up consent UX to Crisp-style inline notice text (`Kayıt olarak ... kabul etmiş olursunuz`) with clickable underlined legal links that open `https://askqualy.com/terms` and `https://askqualy.com/privacy` in a new tab; removed the required checkbox and boxed/wrapper container from register form (`src/components/auth/RegisterForm.tsx`, `messages/tr.json`, `messages/en.json`).
- Changed Usage & Billing AI cards to keep token totals and also show token-derived credit usage preview values (weighted formula) for monthly/all-time visibility (`src/app/[locale]/(dashboard)/settings/billing/page.tsx`, `src/lib/billing/usage.ts`, `messages/en.json`, `messages/tr.json`).
- Changed shared inbound webhook RAG generation to enforce explicit `max_tokens` on OpenAI completion calls (`src/lib/channels/inbound-ai-pipeline.ts`) and added regression coverage to lock the cap (`src/lib/channels/inbound-ai-pipeline.test.ts`).
- Changed monetization docs to record pre-pilot trial-only direction (no freemium), add trial-abuse prevention backlog items, and capture low-entry starter pricing posture (~USD 10 equivalent target band) in roadmap/PRD planning sections (`docs/ROADMAP.md`, `docs/PRD.md`).
- Changed product docs to align Phase 7 Channels scope with implementation: WhatsApp connection status/debug is tracked as implemented, and the standalone "test message sandbox" backlog item was removed from MVP scope (`docs/ROADMAP.md`, `docs/PRD.md`).
- Changed admin dashboard/admin leads markup to include stable Playwright selectors (`admin-dashboard-page`, `admin-leads-page`, `admin-readonly-banner`) for smoke automation.
- Changed Inbox `Konuşma Özeti / Conversation Summary` trigger to a hybrid affordance: filled AI sparkles icon (purple→orange glow) plus an inline chevron beside the label for consistent open/close state indication; refresh action nudged slightly right for spacing balance.
- Changed Settings > Channels so non-connected Instagram now shows a disabled `Çok Yakında / Coming Soon` CTA instead of `Bağla / Connect`, and added a Facebook Messenger placeholder card with the same launch-gated CTA.
- Changed Settings > Channels card UI from multi-column tiles to stacked row cards (one channel per row) with full readable channel names and right-side status/action controls.
- Changed Facebook Messenger placeholder icon to `RiMessengerFill` for visual consistency with the Remix icon set used in channel surfaces.
- Changed Channels summary denominator from 3 to 4 to include the new Facebook Messenger placeholder card in the visible channel roster.
- Changed lead-extraction status semantics: insufficient-information business turns now normalize to `undetermined` (score capped low), while `ignored` is preserved for non-business conversations only.
- Changed lead-status visual mapping to include a dedicated purple treatment for `undetermined` chips/dots in Inbox, Admin dashboard recent leads, and Leads table badges.
- Changed lead merge behavior so `service_type` is no longer carried forward from older snapshots when the latest extraction has no service clue; service now stays empty instead of showing stale inferred values.
- Changed lead extraction prompt context to include recent role-labeled conversation turns (`customer`, `owner`, `assistant`) while preserving the latest-5 customer-message grounding window for extracted facts and scoring signals.
- Changed lead extraction locale precedence to `preferred locale > organization locale > message heuristics`; manual Inbox lead refresh now sends active UI locale to extraction.
- Changed inbound extraction locale wiring to avoid forcing per-message language when organization locale is available, improving TR consistency for mixed-message conversations.
- Changed `qualy-lp` footer scoring item semantics from lead scoring to testimonials by updating copy (`Testimonials` / `Müşteri Yorumları`) and retargeting anchor navigation to `/#testimonials`.
- Changed `qualy-lp` footer structure to remove Resources and Company columns, keeping only Product and Legal groups.
- Changed `qualy-lp` Product footer links to section-aware smooth-scroll behavior on homepage and `/#section` fallback navigation from other routes.
- Changed auth messenger preview spacing density: reduced message stack gap, reduced thread viewport height/padding, and reduced thread-to-composer top margin for a tighter chat/composer rhythm.
- Changed Inbox tab indicator behavior to show `(●)` when unread exists instead of unread count in tab title.
- Changed runtime branding text from the legacy product name to `Qualy` in document metadata and shared EN/TR common app labels.
- Changed app favicon pipeline to use `icon-black.svg` via locale metadata icons and app-level `src/app/icon.svg`; removed legacy `src/app/favicon.ico`.
- Changed Telegram/WhatsApp/Instagram brand icons to Remix fill set (`RiTelegramFill`, `RiWhatsappFill`, `RiInstagramFill`) for consistent channel visuals across Channels, Inbox, and Leads.
- Changed desktop main sidebar `Settings` target from `/settings` to `/settings/ai` so desktop opens AI settings directly while mobile quick menu keeps `/settings` list-first flow.
- Changed route prefetch warmups in `MainSidebar`, `SettingsResponsiveShell`, and `MobileBottomNav` to run with a short delayed schedule instead of immediate mount bursts.
- Changed Channels summary count and bot-mode copy to include Instagram as a first-class channel alongside Telegram/WhatsApp.
- Changed WhatsApp and Instagram channel-connect modals from manual credential forms to Meta OAuth authorization flow (no hand-entered access token fields in UI).
- Changed channel platform icon set to filled WhatsApp/Instagram variants and aligned icon usage across Channels, Inbox, and Leads.
- Changed auth forms to remove the in-form Sign In/Sign Up segmented switcher and rely on route-level pages plus footer links.
- Changed auth header branding scale by reducing `/logo-black.svg` size for a lighter top bar.
- Changed auth canvas flow to 3 clearly distinct two-turn scenarios instead of semantically chained conversations.
- Changed auth preview conversation lifecycle to keep 4 bubbles visible per scenario (`user, agent, user, agent`) before scenario switch.
- Changed auth composer disabled state to remain single-line and only expand vertically during `Sending...` feedback.
- Changed auth scoring predictions to start only after the first customer message (no pre-message score prediction shown).
- Changed auth top-left scoring chip to render an initial waiting placeholder state before first customer message (`Waiting/Bekleniyor`, pending score/signal).
- Changed auth scoring UI from below-composer panel to a compact internal-analysis chip under the top-left canvas text block with score/status/progress/signal.
- Changed auth preview to remove the duplicate scoring card under the composer and keep a single scoring surface in the top-left analysis chip.
- Changed auth score bar to an explicit 0-100 progress visualization with stronger hot-status emphasis.
- Changed auth customer bubbles to include explicit role labels (`Customer` / `Müşteri`) for simulation clarity.
- Changed auth canvas to include dynamic score/signal updates after each message (2 hot scenarios, 1 cold scenario).
- Changed support-only cold scenario closing message to concise handoff copy (“request forwarded to support”).
- Changed Sign Up consent row spacing/typography to keep the legal-acceptance sentence on one line on desktop while preserving mobile wrapping.
- Changed auth sending behavior so composer text remains visible during `Sending...`, then resets to placeholder-style empty input after send confirmation.
- Changed auth messenger preview with a short send-delay animation before promoting typed text into the sent user bubble.
- Changed auth composer sizing to a compact single-line presentation with subtle animated density transition.
- Changed auth right-panel preview alignment so the chat interaction block sits closer to vertical center.
- Changed auth messenger preview sequence to send-first timing: customer composes message, message is sent, composer resets, and then Qualy response types in.
- Changed auth right-panel visual from static prompt card to a dynamic messenger preview with top/bottom gradient composer accents and staged message transitions.
- Changed auth preview conversation thread to a capped internal-scroll viewport with hidden scrollbar and top gradient cut, preventing auth layout growth on long previews.
- Changed auth preview bubble stack alignment to bottom-anchor directly above the composer so new/active messages stay near input.
- Changed auth preview thread to fixed/clamped viewport height so the 4th bubble fades/clips at top on shorter desktop heights instead of pushing the canvas.
- Changed auth incoming bubble motion to use smooth enter animation plus typing-height reservation, reducing jitter while bot text appears.
- Changed auth thread/composer spacing so multi-line bot bubbles no longer touch the input/composer area.
- Changed Forgot Password and Reset Password pages to match Sign In/Sign Up visual system (removed nested inner-card wrapper, ink-accent input focus, CTA/link styling, and reset-form password visibility toggles).
- Changed Sign Up input scope to the MVP set (`full_name`, `email`, `password`, consent) and removed the visible company-name input from the form.
- Changed auth page structure to explicitly separate Sign In and Sign Up routes (`/login`, `/register`) and cross-link via footer actions.
- Changed system-admin active organization resolution to default slim mode (active org only) during route transitions; full org list now loads lazily when the sidebar picker opens.
- Changed desktop `MainSidebar` prefetch warmup to include core workspace/AI/admin routes in addition to settings destinations.
- Changed admin organization switcher UX from always-open inline list to compact summary + modal picker to reduce sidebar noise.
- Changed skill-testing scope to simulator-first in product docs (no separate per-skill playground planned for MVP).
- Changed roadmap/PRD admin scope tracking to reflect completed dashboard recent-leads wiring and platform-admin lead-list flow.
- Changed main sidebar Settings entry target from `/settings/channels` to `/settings` to reduce first-load weight and keep navigation app-like.
- Changed Inbox conversation-list header surface from white to the same muted panel tone as the rest of the list column for visual consistency.
- Simulator chat UI now uses a neutral chatbot surface (channel-agnostic header, message pane, and bubble styles) instead of WhatsApp-like wallpaper/green header/read ticks.
- Changed Next.js locale interception file convention from `src/middleware.ts` to `src/proxy.ts` to align with Next.js 16.
- Changed locale layout to remove the unused Material Symbols webfont `<link>` and keep shell font loading warning-free.
- Changed Knowledge document post-processing to pass bounded context into suggestion generators instead of full raw document bodies.
- Replaced broad `any` usage with concrete/unknown-safe typing patterns in core runtime paths (fallback, follow-up, AI settings, usage, inbox actions, knowledge actions, extraction, offering profile, telegram client).
- Updated `scripts/tests/main-sidebar.test.js` into a proper Vitest suite and aligned chat style exports with existing tests.
- Leads desktop table now keeps `Durum` chips on a single line and truncates long contact names to one line for cleaner row height consistency.
- Settings route composition now uses a shared `settings/layout.tsx` shell so desktop navigation keeps the inner settings sidebar mounted while only detail content updates.
- Lead extraction summary persistence now stays aligned with the current extraction window (latest 5 customer messages) instead of carrying over stale summaries when the latest extraction omits summary.
- Lead extraction strict-retry validation now requires `summary` together with `score` and `status` keys.
- Shadow-mode inbox inactive banner copy is now compact (`Yapay zeka asistanı devrede değil.` + `Dinleyici modunda yanıt gönderilmez.`) with reduced card footprint.
- Inbox scroll-to-latest CTA is now anchored on the composer divider and restyled with a subtle gray tone for clearer but less distracting visibility.
- Inbox composer spacing between the summary row and assistant banner is now tighter.
- Knowledge Base mobile edit header now uses compact copy (`Düzenle`, `Kaydet`) and hides back text (icon-only) to match Skills-style density.
- Skills detail header action buttons now use standardized delete/save icon + label patterns (desktop/mobile compatible).
- Mobile Skills detail header now uses shorter labels (`Düzenle`, `Kaydet`) to reduce top-bar crowding; desktop labels are unchanged.
- Mobile bottom navbar now prefetches main destinations on mount, reducing perceived delay when switching tabs.
- Mobile “Diğer > Ayarlar” shortcut now opens `/settings` (settings list landing) instead of jumping directly to Channels.

### Fixed
- Fixed premium extra-credit checkout being blocked (`topup_not_allowed`) on environments still running the legacy DB top-up rule by adding a compatibility fallback in `simulateMockTopupCheckout` that validates premium membership and completes the mock top-up flow via service-role writes (`src/lib/billing/mock-checkout.ts`, `src/lib/billing/mock-checkout.test.ts`).
- Fixed admin dashboard used-credit inconsistencies (for example dashboard showing `0,2` while org detail showed ~`30`) by recalculating dashboard credit totals from `organization_ai_usage` with the billing-weighted credit-cost formula instead of relying on incomplete ledger rows (`src/lib/admin/read-models.ts`, `src/lib/admin/dashboard-usage-metrics.ts`).
- Fixed mobile Settings detail back navigation history loop by switching to replace-based return flow (prevents back/forward oscillation between `/settings` and detail routes) (`src/components/settings/SettingsResponsiveShell.tsx`).
- Fixed mobile auth UX on Sign In/Sign Up (and shared password-recovery inputs) by using iOS-safe small-screen input sizing (`text-base` / 16px) to prevent keyboard-triggered auto zoom, and stabilized auth viewport/background behavior to remove top/bottom black bars on mobile (`src/components/auth/LoginForm.tsx`, `src/components/auth/RegisterForm.tsx`, `src/components/auth/passwordRecoveryStyles.ts`, `src/app/[locale]/(auth)/layout.tsx`, `src/app/globals.css`).
- Fixed Inbox details refresh `useEffect` dependency regression that triggered React console error (`The final argument passed to useEffect changed size between renders`) during Turbopack hot reloads (`src/components/inbox/InboxContainer.tsx`).
- Fixed admin runtime serialization errors (`Only plain objects can be passed to Client Components`) by removing server-to-client icon constructor props in admin empty-state tables and rendering icon markup directly in server pages (`src/app/[locale]/(dashboard)/admin/organizations/[id]/page.tsx`, `src/app/[locale]/(dashboard)/admin/organizations/page.tsx`, `src/app/[locale]/(dashboard)/admin/users/page.tsx`, `src/app/[locale]/(dashboard)/admin/users/[id]/page.tsx`).
- Fixed signout redirect host drift by deriving `/register` redirect origin from runtime request/forwarded headers instead of static `NEXT_PUBLIC_APP_URL`, preventing redirects to legacy Netlify domains on custom-host deployments (`src/app/api/auth/signout/route.ts`, `src/app/api/auth/signout/route.test.ts`).
- Fixed Leads list required-field rendering so values extracted into Inbox "Important info" (`extracted_fields.required_intake_collected`) now appear in both desktop table columns and mobile lead cards.
- Fixed greeting-only first-contact turns remaining `ignored` when extraction returned `non_business=true` by normalizing greeting-only conversations to `undetermined`.
- Fixed profile-only service hallucination in greeting-only conversations (for example, `Hello`) by nulling inferred `service_type` unless customer text contains a concrete service clue.
- Fixed Inbox conversation-list lead-chip drift by syncing row status on manual refresh/realtime lead updates, including `ignored` (`Yok sayıldı`).
- Fixed Inbox refresh-time missing lead chips by normalizing one-to-one nested `leads` payloads in `getConversations`, so chips render without opening each conversation first.
- Fixed TR UI extraction refresh mismatch where lead summary/details could remain English after Turkish UI-triggered refreshes.
- Fixed Netlify deep-link 404s for landing legal routes by adding SPA redirect fallback (`public/_redirects` with `/* /index.html 200`), so direct visits to `/legal`, `/terms`, and `/privacy` resolve correctly.
- Fixed Meta OAuth status/error redirects to use the active request origin for Channels-page return, preventing unexpected fallback to legacy Netlify domain URLs.
- Fixed Meta OAuth route host resolution drift on Netlify by using canonical app URL/forwarded-host resolution for both start and callback routes.
- Fixed opaque OAuth callback failures by attaching compact `meta_oauth_error` hints to `connect_failed` redirects.
- Fixed popup OAuth handoff dropping `meta_oauth_error`; main Channels URL now preserves the callback error hint after popup closes.
- Fixed WhatsApp connect failures caused by Graph error `(#100) Tried accessing nonexisting field (whatsapp_business_accounts) on node type (User)` by adding business-edge fallback queries.
- Fixed Meta OAuth status redirects to always return to a safe channel-settings URL (`returnTo`) so failed OAuth/env states no longer strand users on non-matching paths.
- Fixed mixed channel icon rendering inconsistencies by unifying Telegram/WhatsApp/Instagram under Remix fill variants (`RiTelegramFill`, `RiWhatsappFill`, `RiInstagramFill`).
- Fixed perceived navigation stalls during active interactions by deferring bulk prefetch calls with a short delayed schedule.
- Fixed Sign In and Sign Up page CTA styling so primary submit buttons and auth switch links now use the ink accent `#242A40` instead of blue.
- Fixed slow-feeling system-admin navigation caused by full organization-list reads on each route transition in dashboard context resolution.
- Fixed admin sub-route blank-wait transitions by adding explicit loading skeletons (organizations/users/detail pages) with immediate visual feedback.
- Fixed Next.js server/client serialization errors on admin dashboard (`Only plain objects can be passed to Client Components`) by rendering stat cards server-side instead of passing icon components through `StatCard` props from a server route.
- Fixed Inbox false-empty list states by adding a resilient fallback path in `getConversations`: when nested relational reads fail, the server now returns base conversations plus best-effort message/lead/assignee previews via flat per-table queries.
- Fixed noisy admin dashboard runtime error overlay by downgrading expected totals-RPC fallback logging from error-level to graceful fallback logs.
- Fixed slow-feeling settings transitions by removing a redundant auth read in settings layout and warming settings routes in advance.
- Fixed stale-closure risk in unsaved-changes save flow by including `transformPendingHref` in `useUnsavedChangesGuard` callback dependencies.
- Fixed failing inbox style tests by restoring `getInboxOutgoingBubbleClasses` export.
- Fixed Vitest failure caused by a non-suite test file (`scripts/tests/main-sidebar.test.js`) by converting it into an executable test suite.
- Fixed React hook rule violations (`rules-of-hooks`, `set-state-in-effect`) in Knowledge, Settings, and Auth flows.
- Fixed build-time type regressions introduced by strict typing updates (channel debug result narrowing, inbox optimistic message typing, dropdown clone typing).
- Desktop Settings sub-page navigation no longer flashes/replaces the whole settings shell with skeletons; sidebar remains stable while detail pane loads.
- Mobile Settings detail→list back navigation no longer behaves like a full refresh; it now returns via client-side transition for a stable mobile flow.
- Inbox conversation list header no longer shows a dropdown chevron next to the “Gelen Kutusu / Inbox” title.
- Inbox summary panel now regenerates summary on every reopen; manual refresh is no longer required after close/reopen.
- Fixed inbox conversation switching flicker by tracking selected-thread vs loaded-thread state and showing skeletons until selected-thread messages hydrate, so avatars/details no longer jump ahead of message content.
- Telegram webhook skill-matching failures now fail open to KB/fallback processing, preventing silent no-reply drops when embedding/match calls error.
- Telegram webhook AI gating no longer gets blocked by stale `assignee_id` when `active_agent` is already bot; runtime operator-active checks now honor `active_agent` as source of truth.
- Hot-lead `notify_only` escalation now preserves ongoing AI replies as intended (only `switch_to_operator` silences AI).
- Supabase migration version collision: renamed `00020_send_operator_message_rpc.sql` to `00052_send_operator_message_rpc.sql` so `schema_migrations.version` is unique.
- i18n hardcoded-string violations for simulator platform fallback labels in Inbox/Leads and static summary panel id attribute usage.
- Platform admin dashboard stat cards now use a single DB aggregate RPC instead of loading full organization summaries for global totals.
- Platform admin organization list now avoids in-memory full-list filtering/pagination by using DB-backed count + ranged queries.
- Platform admin organization aggregates now use batched reads instead of per-organization N+1 fan-out, and organization detail now loads targeted org/member/profile slices.
- Platform admin user list no longer triggers heavy organization summary aggregation; it now uses lightweight org identity lookups.
- Platform admin user detail now loads targeted profile/membership/organization slices instead of scanning full user+org read models.
- Removed unused `NavIconComponent` type in `MainSidebar` to keep admin-related lint checks clean.

### Added
- Offering Profile AI Suggestions accordion header now shows a compact pending badge (dot + count) while collapsed.
- Knowledge Base “Review/İncele” CTA now deep-links to Organization settings and auto-expands the Offering Profile AI Suggestions accordion.
- Offering Profile AI Suggestions now surface pending indicators inside the accordion content/tabs in addition to sidebar/header indicators.
- Skill/KB updates now trigger AI Required Fields chip generation by requesting only missing fields from current context.
- Subagent-driven-development skill added for subagent-based plan execution.
- Offering Profile AI suggestions review workflow (pending/approved/rejected tabs, accept/reject actions, empty states, and show-more).
- Offering Profile AI suggestions manual generate action (shown when no suggestions exist).
- Offering Profile AI suggestions now use a hybrid format (intro + up to 5 bullets) and support update proposals for conflicting content.
- Offering Profile AI suggestions now consider manual summary plus approved/rejected history for better alignment.
- Offering Profile AI suggestions now enforce 3-5 labeled bullets and retry when output is too sparse.
- Knowledge Base banner surfaces pending AI suggestions and links to Organization settings.
- Knowledge Base async processing endpoint with client-side enqueue after save/update.
- Supabase realtime publication now includes knowledge tables for instant sidebar updates.
- Knowledge Base realtime delete events now include full row data for filtered subscriptions.
- Supabase realtime publication now includes offering profile suggestions for indicator updates.
- Knowledge Base create/edit/delete now navigate immediately while processing continues in the background.
- Pending AI suggestion indicators in settings sidebar and organization profile section.
- Main sidebar Settings indicator for pending AI suggestions.
- Locale-aware AI suggestion generation and localized timestamps in settings.
- Offering Profile AI suggestions now default to enabled for new orgs.
- AI suggestion generation now follows the active UI locale (no dual-language generation).
- AI suggestions can be moved between approved and rejected states.
- Suggestion tabs now remain accessible even when empty, and pending indicators refresh after reviews.
- Lead extraction schema (offering profile, service catalog, candidates, leads).
- Lead extraction worker wired to Telegram webhook with token usage logging.
- Offering Profile settings UI with pending profile updates and service candidate approvals.
- Inbox details now show a read-only lead snapshot (status, score, service, summary).
- Inbox lead score reasoning modal (on-demand AI explanation of the current score).
- Inbox details now place contact info under Key Information and keep status badges content-hugging.
- Inbox details now show a paused lead extraction notice with a manual refresh action.
- Inbox lead header now shows an updating indicator while extraction runs.
- Inbox lead header keeps the updated timestamp visible while updating.
- Lead scoring helpers and extraction parsing utilities.
- Lead extraction design spec (hybrid service catalog, offering profile, non-business skip, async per-message snapshot).
- AI Settings toggle to keep lead extraction running during operator takeover.
- Organization settings now use independent AI toggles for Offering Profile and Required Fields sections.
- Required Fields section includes its own AI toggle, on-demand manual add, and subtle AI tags.
- Approved AI suggestions tab now includes a persistent custom profile-note textarea (editable/removable) that is stored separately from suggestion cards.
- Manual approved additions are persisted as approved offering profile suggestions.
- Org-level bot mode (Active/Shadow/Off) with AI Settings selector, sidebar status indicator, and Telegram reply gating (Simulator unaffected).
- Auth password recovery flow (Forgot Password + Reset Password screens).
- Profile settings password section with reset link CTA and cooldown.
- Inbox conversation summary (on-demand button + inline panel).
- AI settings bot name (org-level) used in AI prompts and summaries.
- Inbox chat labels now show the configured bot name.
- Usage & Billing settings with monthly (UTC) + total AI token tracking.
- Usage & Billing now shows a breakdown for summary, messages, and lead extraction.
- Usage & Billing monthly card now displays the UTC month label (e.g., February 2026).
- Usage & Billing detail link is now placed under the UTC note text.
- Next.js 14 project with App Router and TypeScript
- Strict TypeScript configuration (`noUncheckedIndexedAccess`, `noImplicitReturns`)
- Prettier + ESLint with strict rules
- Supabase client/server setup (`src/lib/supabase/`)
- i18n support with next-intl (Turkish + English)
- Locale-aware routing (`/[locale]/`)
- Environment variables template (`.env.local.example`)
- Comprehensive README with setup instructions
- Project documentation (PRD, Roadmap, AGENTS.md)
- **Phase 1: Multi-Tenant Infrastructure**
  - Supabase migrations (schema, RLS policies, auth triggers)
  - Database types (`src/types/database.ts`)
  - Organizations, profiles, organization_members tables
  - Auth pages (login, register) with i18n
  - Protected dashboard with organization display
  - OrganizationContext for client-side org management
  - Sign out API route
- **Phase 3: Skill System**
  - Skills table with pgvector for semantic search
  - Embedding generation with OpenAI text-embedding-3-small
  - Skill CRUD operations (create, edit, delete, toggle)
  - Skills admin UI (list, create, edit pages)
  - Skill test playground with similarity matching
  - i18n translations for skills (EN/TR)
- **Phase 3.5: WhatsApp Simulator**
  - Realistic WhatsApp-style chat UI
  - Real-time skill matching simulation
  - Org-specific simulation context
  - Debug panel with confidence scores and matched skill details
  - Dynamic sensitivity threshold slider (0.0 - 1.0)
- **Phase 3.6: Refinements & Inbox**
  - **Refactoring:** Replaced all `material-symbols-outlined` with `lucide-react` icons for modern consistency.
  - **Inbox:** Implemented lazy loading (infinite scroll) for conversations.
  - **Inbox:** Added "Delete Conversation" functionality with cascading database deletes.
  - **Inbox:** UI improvements (message previews, simplified list items).
  - **Inbox:** Composer banner and takeover placeholder to surface bot-active state.
  - **Inbox:** Removed mock data creation; now fully driven by real database data.
- Crisp-inspired main sidebar with collapsible state and active navigation pill.
- Refined collapsed sidebar icon sizing and header toggle placement.
- Centered collapsed logo alignment to match icon stack.
- Eyebrow section labels added for Workspace, AI Tools, and Other groups.
- Added extra top padding between the sidebar header and first section label.
- **Enterprise RAG Hardening:** Knowledge documents + chunks schema, chunking with overlap, token-budgeted context assembly, and chunk-level retrieval RPC with service-role-safe search for webhooks.
- Knowledge Base UI now shows indexing status badges (Ready / Processing / Error).
- Contextual KB routing with LLM-based decision + follow-up query rewrite.
- Router now receives the last bot reply and the last five user messages with timestamps to improve follow-up handling.
- Simulator now shows per-message token usage (input/output/total) plus router/RAG breakdown and conversation totals in debug and bubbles.
- Automated i18n guard: hardcoded UI string scan + EN/TR key parity check (`npm run i18n:check`) wired into lint.
- Expanded EN/TR translations for admin, channels, simulator, inbox details, and auth placeholders.
- Inbox unread indicators now appear in the main sidebar and conversation list.

### Added
- **v0.5.0: Knowledge Base Parity**
  - **Simulator RAG Fallback:** Implemented RAG (Retrieval-Augmented Generation) in the `ChatSimulator`. It now falls back to the Knowledge Base (OpenAI + Embeddings) if no skill matches, mirroring the production Telegram behavior.
  - **Documentation:** Updated PRD and Roadmap to reflect current status.

### Added
- **v0.4.0: Active Agent & Realtime Inbox**
  - **Explicit Active State**: Added `active_agent` column ('bot' | 'operator') to prevent AI interference.
  - **Double-Lock Logic**: AI is now blocked if `active_agent === 'operator'` OR `assignee_id` is present.
  - **Assignee System**: Operators can "Claim" conversations; replying automatically assigns the user.
  - **Realtime Updates**: Enabled `supabase_realtime` for instant message delivery and inbox sorting.
  - **Optimistic UI**: Instant feedback on send, with "temp" message deduplication logic.
  - **Inbox Polish**: Robust auto-scroll, "Unassigned" filters, and simplified Details Panel (Status/Platform icons refined).
  - **Developer**: Added error boundaries to `sendMessage` and strictly typed DB interfaces.
- **Workflow**: Agents must always include a commit message in responses.

### Changed
- Collapsed sidebar header brand icon (`/public/icon-black.svg`) now renders at `44px` so it visually matches the active navigation pill footprint.
- Sidebar navigation accent palette now uses ink `#242A40` (replacing blue) for active pills, indicators, and focus rings in `MainSidebar`, `GlobalRail`, and `KnowledgeSidebar`.
- Skills and Knowledge Base primary CTA buttons now use ink `#242A40` (replacing blue) across create/save actions, including modal and empty-state CTAs.
- Settings page headers now reuse settings sidebar labels for title parity (AI and General pages).
- Skill matching context now uses title-aware embeddings instead of trigger-only embeddings.
- Skills empty-state icon now uses the same icon family/glyph as the sidebar Skills navigation item for visual consistency.
- Skills page now uses a single unified list; Core/Custom tabs were removed and default/user-added skills are managed from the same list.
- Usage & Billing page now renders three usage sections in one flow: AI token usage, message usage, and storage usage.
- Usage & Billing message usage cards now render AI/operator/customer counts on separate rows instead of a single inline sentence.
- AI Settings bot mode and escalation action selection cards now use a more compact size (smaller title/radio/padding).
- AI Settings selection card titles are now section-title sized, and description text is reduced one step for tighter layout.
- Inbox conversation list cards now use a 3-row text stack (name + right-aligned lead chip, one-line message preview, and time on the third row).
- Inbox bot message bubbles now use a darker violet background with lighter text for stronger visual contrast.
- Offering Profile AI Suggestions accordion header now shows only one pending indicator label and removes the redundant right-side count chip.
- Telegram and Simulator KB/fallback replies now use required-fields + recent-customer-message context so LLM can naturally ask one smart follow-up question when needed.
- Telegram and Simulator KB/fallback follow-up context now also includes the last 3 assistant replies to reduce repeated greetings in consecutive turns.
- Telegram and Simulator final KB/RAG/fallback generation now includes recent multi-turn user+assistant history (not only routing), improving conversational continuity.
- Telegram KB/fallback generation now also receives current lead snapshot facts (`service_type` + extracted fields) to avoid re-asking already captured details.
- KB router now keeps multiple recent assistant turns (instead of only one) for better follow-up routing and query rewrites.
- Lead extraction now asks for and persists `required_intake_collected` values in `leads.extracted_fields` when required fields are clearly provided by the customer.
- Lead extraction now uses merge-on-update persistence so previously extracted service/summary/required-info values are not wiped when later turns omit those fields.
- Inbox lead details now show collected values in an "Important info" card section with plain label-value rows inside, sourced from Organization > Required Fields.
- Required-info resolution now supports manual override precedence (`required_intake_overrides`) for future lead-edit flows.
- Docs: Roadmap/PRD now explicitly track deferred Inbox manual overwrite UI for "Important info" (per-field edit + source tracking).
- Required Fields normalization is now case-insensitive so manual and AI chips avoid duplicates (including previously suggested values).
- Turkish UI copy now uses "Kişi" instead of "Lead".
- Main sidebar navigation now swaps active/passive icons per item for selected states.
- Knowledge Base routes now show skeleton loaders during navigation to avoid blank waits.
- Inbox conversation list now shows a lead status dot beneath the platform badge.
- Settings sidebar icons updated to the bubbles/circle user icon set.
- Lead scoring now weights decisive booking intent higher and augments intent signals with keyword heuristics.
- Inbox details now keep the contact header while grouping the lead snapshot under Key Information.
- Lead score reasoning now respects the active UI language and uses localized status labels.
- Inbox lead score link text updated and "Received" label now shows as "Created" in English and "Oluşturuldu" in Turkish.
- Lead snapshot header now shows an AI extraction micro-label and status uses a minimal dot + text treatment.
- AI extraction micro-label now sits next to the lead header for tighter alignment.
- Platform row now displays the channel icon and channel cards use consistent icon sizing.
- Platform icons now use react-icons with brand colors for Telegram and WhatsApp.
- Inbox list avatars now include platform badges for quick channel identification.
- Inbox list platform badges now use larger, brand-colored icons with a light backdrop.
- Inbox list platform badges now sit centered beneath avatars.
- Inbox list platform badges are larger with a thinner border and lower placement.
- Inbox list platform badges moved further down with larger icons and lighter borders.
- Inbox list platform badges lowered again with thinner borders and larger icons.
- Offering Profile suggestions now support archiving rejected items (audit-only) with an archived tab, and the generate button appears whenever there are no pending items.
- Knowledge Base pending AI suggestions banner now uses an amber tone for better visibility.
- Lead extraction now uses only approved Offering Profile AI suggestions.
- Lead extraction ignores update proposals (only approved base suggestions are used).
- New AI suggestions start in a pending state until reviewed.
- Offering Profile management moved to Organization Settings for clearer org-level ownership.
- Settings forms now use consistent column widths and inputs align with section titles (no duplicate field labels).
- Offering Profile now supports manual text plus optional AI suggestions that append below without overwriting.
- Bot mode copy refined (TR: “Dinleyici”, clearer descriptions) and radio indicator sizing aligned.
- Active mode TR copy now mentions background lead extraction.
- Sidebar bot status dot now uses green/amber/red for Active/Dinleyici/Kapalı.
- Docs: define org-level bot mode (Active/Shadow/Off) and sidebar status indicator placement.
- Docs: add inbox conversation summary design spec.
- Inbox summary UI refined to hide refresh until summary completes, with reduced spacing above the AI banner.
- Skills list: moved search above tabs and kept the add button visible in the header.
- Auth screens redesigned to align with the settings UI (light theme, updated form styling).
- Docs: Updated PRD/Roadmap to reflect Telegram sandbox integration and current implementation status.
- Inbox composer banner copy now references the AI assistant and centers the banner content vertically.
- Global font updated to Plus Jakarta Sans via Google Fonts import.
- Sidebar toggle now uses arrow-from-line icons for clearer affordance.
- Knowledge Base banner copy now emphasizes service profile suggestions and adds spacing from the header.
- Knowledge Base save/update now return immediately with background processing and UI polling.
- Lead scoring now uses LLM-provided score/status from the latest 5 customer messages (assistant messages excluded).
- Lead extraction now injects the latest customer message into the LLM prompt to avoid missing fresh messages.
- Lead extraction now includes persistent manual profile notes together with approved AI suggestions in its profile context.
- Offering Profile UI now switches by its own AI mode: manual textarea when AI is off, suggestions workflow when AI is on.
- Offering Profile summary now syncs from approved suggestions after review/archive/manual-approved actions.

### Fixed
- AI Settings now repairs localized handover message defaults so Turkish UI shows the Turkish bot handover message instead of the English default when legacy/default data is mismatched.
- AI Settings prompt textarea now applies locale-aware default repair so Turkish UI shows Turkish prompt instructions instead of English default text, including legacy long EN default prompt variants.
- Inbox realtime subscriptions now recover auth tokens via session refresh and keep realtime auth synced on auth state changes, preventing stale live message streams that required manual page refresh.
- Usage & Billing detail breakdown now includes `lead_reasoning` tokens in the Lead Extraction bucket so detail totals align with monthly/all-time totals.
- Reduced repeated "Merhaba"/opening loops by applying repeated-greeting suppression when recent assistant turns already greeted.
- Manual custom profile text in Approved tab no longer gets inserted as a suggestion card or toggles AI mode unexpectedly.
- Required Fields auto-generation now parses fenced/noisy JSON outputs from AI responses, so KB-triggered chips are persisted reliably.
- Required fields chip remove button now uses a centered icon with a larger hit area for better alignment and usability.
- Knowledge Base sidebar file clicks now open the document details view.
- Inbox platform badge alignment restored after adding the lead status dot.
- Lead status dot now updates via realtime lead changes (no manual refresh needed).
- Knowledge Base sidebar now highlights the active document and adds spacing between All Content and Uncategorized sections.
- Knowledge Base sidebar now refreshes immediately via realtime document/collection updates.
- Removed legacy `knowledge_base` table in favor of documents/chunks.
- Replaced remaining hardcoded UI strings with translation keys across the app.
- Updated AGENTS.md to enforce multilingual-first feature development.
- KB routing now favors definition-style questions and retries with a lower similarity threshold when initial KB search is empty.
- Chunk overlap now aligns to paragraph/sentence boundaries to avoid mid-sentence splits.
- Knowledge sidebar now lists uncategorized items (max 10 with expand) and shows accurate all-content counts.
- Simulator debug panel now hides per-request token breakdown (per-bubble + conversation totals remain).
- Knowledge Base UI terminology now uses "folder" instead of "collection".
- Knowledge Base search now falls back to keyword matching when embeddings fail or return no results.
- Simulator fallback now suggests available topics based on existing skills and knowledge documents when no match is found.
- Org-level AI settings with always-on Flexible mode, single threshold, and single prompt for fallback behavior.
- Settings pages now use a two-column section layout for clearer configuration.
- Added Profile and Organization settings pages with header save + unsaved change confirmation.
- Settings pages now show a top-right save button that activates only when changes are detected.
- Removed redundant current-value summaries above settings inputs and selections.
- Unsaved changes modal now uses soft-danger discard, single-line save CTA, and content-hugging secondary buttons.
- Channels page title standardized to "Channels" with wider channel cards.
- AI settings load now falls back quietly unless debug logging is enabled.
- Flexible fallback now uses only the UI-configured prompt (no hardcoded system append).
- Localized AI settings copy in Turkish (Yetenek terminology + clearer sensitivity helper text).
- Inbox conversation avatars now use the shared Avatar component for consistent initials and colors.
- Lead extraction now parses fenced or noisy JSON outputs so lead snapshots update correctly.
- Lead extraction now prioritizes customer messages and avoids assistant-only service inference.

### Fixed
- TypeScript build errors in Telegram webhook + Simulator history typing and KB router/chunking index guards.
- Inbox now refreshes messages on conversation updates to surface bot/contact replies in realtime.
- Manual replies atomically assign the current operator to prevent "Unassigned" state until refresh.
- Realtime subscriptions now attach the session token before subscribing (fixes missing live updates).
- Inbox details avatar now uses full initials to match the conversation list.
- RAG now enforces NO_ANSWER fallback and handles retrieval errors without failing the webhook.
- Knowledge base sidebar now refreshes after folder create/delete actions triggered outside the sidebar.
- Simulator KB fallback now answers definition-style questions that previously fell through routing.
- Inbox unread counts now reset on open and only increment for contact messages.
- Settings save buttons now reset clean state and avoid stray unsaved-change prompts.

---

## Version History

| Version | Date | Summary |
|---------|------|---------|
| 0.5.0 | 2026-02-02 | Knowledge Base Parity (Simulator RAG) |
| 0.4.0 | 2026-02-02 | Active Agent State, Realtime Inbox, & Assignee System |
| 0.3.5 | 2026-01-31 | Phase 3.5: WhatsApp Simulator & Dynamic Thresholds |
| 0.3.0 | 2026-01-31 | Phase 3: Skill System |
| 0.2.0 | 2026-01-31 | Phase 1: Multi-tenant infrastructure + auth |
| 0.1.0 | 2026-01-31 | Phase 0: Project setup complete |
| 0.0.0 | 2026-01-31 | Project kickoff, documentation created |
